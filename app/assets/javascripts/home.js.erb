"use strict";

$(document).ready(function(){

  navigator.geolocation.getCurrentPosition(positionSuccess, positionError);

  function positionSuccess(position){
    var latitude = position.coords.latitude;
    var longitude = position.coords.longitude;
    
    var currentLocationRequest = stopMonitorRequest(latitude, longitude);
    findNearestStops(currentLocationRequest);
  }

  function positionError(error){
    return console.warn('ERROR: ' + error.code + ': ' + error.message);
  }

});
    

// Creates a URL for the MTA's stop API with the user's current location
function stopMonitorRequest(latitude, longitude){
  var response = "http://bustime.mta.info/api/where/stops-for-location.json?lat=" + latitude + "&lon=" + longitude + "&latSpan=0.003&lonSpan=0.003&key=<%= ENV['MTA_API_KEY'] %>" ;
  return response;
}

// Finds all the nearest bus stops
function findNearestStops(response){
  $.ajax({
    type: "GET",
    dataType: "jsonp",
    url: response,
    data: {},
    success: function(result){    
      var stopObjects = Array.prototype.slice.call(result.data.stops);
      groupStopsWithRoutes(stopObjects);
    }
  })
}
           
// {
//   stopID: "13432142",
//   routes: [{object1}, {object2}, {object3}]
// }



function groupStopsWithRoutes(stopObjects){
  var allStopIDs = [];
 
  // Only need unique stop IDs for now -- use those unique IDs to grab all the information in the call to the approaching buses API.

    stopObjects.forEach(function(stopObject){
            allStopIDs.push(stopObject.code);
        
        // if (groupedStopsByID.length === 0){
        //   var newStop = {
        //     stopID: stopObject.code,
        //     crossStreets: stopObject.name,
        //     routes: []
        //   }
        //   groupedStopsByID.push(newStop);
        // } 
    })
         // debugger; // console.log(groupedStopsByID);
  var uniqueStopIDs = _.uniq(allStopIDs)
  debugger;
}

// function getRoutesRequest(stopObjects){
//   var allRouteObjects = [];
//   stopObjects.forEach(function(stopObject){        
//     stopObject.routes.forEach(function(route){
//       allRouteObjects.push({
//         stopId: stopObject.code,
//         busId: route.shortName,
//         crossStreets: stopObject.name,
//         direction: "",
//         nextBus: []
//       });
//     })    
//   }); 
//   checkNextBuses(allRouteObjects);
// }


// function checkNextBuses(allRouteObjects){
//   allRouteObjects.forEach(function(route){
//     console.log(route);    
//   })
// }




//                   // START AJAX CALL

//                   $.ajax({
//                     type: "GET",
//                     dataType: "jsonp",
//                     url: buses,
//                     data: {},
//                     success: function(result){
//                       // Retrives the next few buses that are stopping at that stop.
//                       var allBuses = result.Siri.ServiceDelivery.StopMonitoringDelivery[0].MonitoredStopVisit;
//                       // debugger;

//                       allBuses.forEach(function(thisBus){
//                         var farAway = thisBus.MonitoredVehicleJourney.MonitoredCall.Extensions.Distances.PresentableDistance ;
                        
//                         busStop.destination = thisBus.MonitoredVehicleJourney.DestinationName;  
//                         busStop.nextBus.push(farAway);
//                         debugger;
//                       })
//                     }
//                   });



//                   // END AJAX CALL

//                   // debugger;
//                 });

//                 // debugger;
                
//           }                   
//         });
//       }
//            findNearestStops();  
//                 // debugger;

//     }
