"use strict";

$(document).ready(function(){
  
  navigator.geolocation.getCurrentPosition(positionSuccess, positionError);

  function positionSuccess(position){
    var latitude = position.coords.latitude;
    var longitude = position.coords.longitude;
    
    var currentLocationRequest = stopMonitorRequest(latitude, longitude);
    findNearestStops(currentLocationRequest);
  }

  function positionError(error){
    return console.warn('ERROR: ' + error.code + ': ' + error.message);
  }

});
    

// Creates a URL for the MTA's stop API with the user's current location
function stopMonitorRequest(latitude, longitude){
  var response = "http://bustime.mta.info/api/where/stops-for-location.json?lat=" + latitude + "&lon=" + longitude + "&latSpan=0.007&lonSpan=0.007&key=<%= ENV['MTA_API_KEY'] %>" ;
  return response;
}

// Finds all the nearest bus stops
function findNearestStops(response){
  $.ajax({
    type: "GET",
    dataType: "jsonp",
    url: response,
    data: { format: 'json' },
    success: function(result){    
      var stopObjects = Array.prototype.slice.call(result.data.stops);
      requestStopData(stopObjects);
    }
  });
}

// Send a request for each stops latest info, display the request on page.
function requestStopData(stopObjects){
  
  stopObjects.forEach(function(stop){
  
    var route = "http://bustime.mta.info/api/siri/stop-monitoring.json?key=<%= ENV['MTA_API_KEY'] %>&MonitoringRef=" + stop.code;
      
    var thisStop = stop;
    
    $.ajax({
      type: "GET",
      dataType: "jsonp",
      url: route,
      data: { format: 'json' },
      success: function(result){
      
      var currentStopOBA = thisStop;
      var currentStopSiri = result.Siri.ServiceDelivery.StopMonitoringDelivery[0].MonitoredStopVisit;
      
      currentStopSiri.forEach(function(stop){
        
        if (currentStopSiri !== undefined){

          var currentStopOBA = thisStop;
          // debugger;
          var busName = stop.MonitoredVehicleJourney.PublishedLineName;
          var busDestination = stop.MonitoredVehicleJourney.DestinationName;
          // var busDestinationRegex = busDestination.replace(/ via.*/, '') ;
          var busDistanceAway = stop.MonitoredVehicleJourney.MonitoredCall.Extensions.Distances.PresentableDistance;
          
          var googleMaps = "http://maps.google.com/maps?z=12&t=m&q=loc:" + currentStopOBA.lat + "+" + currentStopOBA.lon;
          
          var busStopsAway = stop.MonitoredVehicleJourney.MonitoredCall.Extensions.Distances.StopsFromCall;

          var thisBusHeader = '.' + currentStopOBA.code;
          var compass_image = "<img src='/assets/compass-57282c795d837e8775337f44cdf20b3c3f5c0babbbb0eb87a1b5919f0b35168a.png' alt='Compass 57282c795d837e8775337f44cdf20b3c3f5c0babbbb0eb87a1b5919f0b35168a' class='icon_compass'>"
          // var bus_image = "<img src='/assets/bus-510e1a5a5a6e45d67d9f6412ad121977bb9edb8dd0aac8c061b33dfd1e9eb860.png' alt='Bus 510e1a5a5a6e45d67d9f6412ad121977bb9edb8dd0aac8c061b33dfd1e9eb860' class='icon_bus'>" 

          $('.my-buttons').click(function(){
            
           // debugger;
            if ($(thisBusHeader).length > 0){

              $(thisBusHeader).last().append(
                "<div class='bus-item col-xs-12'>" 
                // "<%= image_tag('bus_image.png', class: 'icon_bus') %>" 
                + "<p>" + busDistanceAway + "<br>" + busStopsAway + " stops away" + "<p>" + "</div>"
                );        

            } else {
              $('#stops').append(
                "<div class='bus-item-header col-xs-12 " + currentStopOBA.code + "'" + ">" + compass_image +
                  "<h2>" + busName + "</h2>" + "<br>" + "<span class='line-info'>"+
                  currentStopOBA.name + "<br>" + 
                  "TO: " + busDestination + "<br>" + "<br>" + "</span>"  
                  + "<div class='bus-item col-xs-12'>"
                  // "<%= image_tag('bus_image.png', class: 'icon_bus') %>" 
                  + "<p>" + busDistanceAway + 
                  "<br>" + busStopsAway + " stops away" + "<p>" + "</div>" 
                  + "</div>"
                );        
            }
          });
        }
      });     
      }
    });
  });
}
