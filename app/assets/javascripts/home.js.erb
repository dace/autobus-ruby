"use strict";

$(document).ready(function(){

      // Gets the user's location
      navigator.geolocation.getCurrentPosition(positionSuccess, positionError);

      // Executes if a position is found
      function positionSuccess(position){
        var latitude = position.coords.latitude;
        var longitude = position.coords.longitude;
        
        var currentLocationRequest = stopMonitorRequest(latitude, longitude);
        var stops = findNearestStops(currentLocationRequest);
        // var routeObjects = ;

      }

      // Executes if no position is found
      function positionError(error){
        return console.warn('ERROR: ' + error.code + ': ' + error.message);
      }

});
    





function stopMonitorRequest(latitude, longitude){
  var response = "http://bustime.mta.info/api/where/stops-for-location.json?lat=" + latitude + "&lon=" + longitude + "&latSpan=0.003&lonSpan=0.003&key=<%= ENV['MTA_API_KEY'] %>" ;
  return response;
}


function findNearestStops(response){
  $.ajax({
    type: "GET",
    dataType: "jsonp",
    url: response,
    data: {},
    success: function(result){    
      var stopObjects = Array.prototype.slice.call(result.data.stops);
      getRoutesRequest(stopObjects);
    }
  })
}
               

function getRoutesRequest(stopObjects){
  var allRoutes = [];
  
  stopObjects.forEach(function(busStop){
     allRoutes.push("http://bustime.mta.info/api/siri/stop-monitoring.json?key=<%= ENV['MTA_API_KEY'] %>&MonitoringRef=" + busStop.stopId);
  })
  debugger;
  return allRoutes;
}


//                   // START AJAX CALL

//                   $.ajax({
//                     type: "GET",
//                     dataType: "jsonp",
//                     url: buses,
//                     data: {},
//                     success: function(result){
//                       // Retrives the next few buses that are stopping at that stop.
//                       var allBuses = result.Siri.ServiceDelivery.StopMonitoringDelivery[0].MonitoredStopVisit;
//                       // debugger;

//                       allBuses.forEach(function(thisBus){
//                         var farAway = thisBus.MonitoredVehicleJourney.MonitoredCall.Extensions.Distances.PresentableDistance ;
                        
//                         busStop.destination = thisBus.MonitoredVehicleJourney.DestinationName;  
//                         busStop.nextBus.push(farAway);
//                         debugger;
//                       })
//                     }
//                   });



//                   // END AJAX CALL

//                   // debugger;
//                 });

//                 // debugger;
                
//           }                   
//         });
//       }
//            findNearestStops();  
//                 // debugger;

//     }



